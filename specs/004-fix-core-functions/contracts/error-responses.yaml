openapi: 3.0.3
info:
  title: InvisiGuard API - Error Responses
  description: Standardized error response schemas for fixed core functions
  version: 1.1.0
  contact:
    name: InvisiGuard Team

paths: {} # Error schemas only, not full API spec

components:
  schemas:
    # Base Error Response
    ErrorResponse:
      type: object
      required:
        - status
        - error_code
        - message
      properties:
        status:
          type: string
          enum: [error]
          description: Always "error" for error responses
        error_code:
          type: string
          description: Machine-readable error identifier (UPPERCASE_SNAKE_CASE)
          example: INVALID_FILE_FORMAT
        message:
          type: string
          description: Human-readable error description
          example: Only PNG and JPG images are supported
        details:
          type: object
          additionalProperties: true
          description: Additional context specific to the error
        suggestion:
          type: string
          description: Actionable guidance for the user
          example: Please convert your image to PNG or JPG format and try again

    # Validation Error
    ValidationError:
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          required:
            - field
            - expected
          properties:
            field:
              type: string
              description: Name of the field that failed validation
              example: alpha
            value_provided:
              description: The invalid value that was submitted
              example: 100.0
            expected:
              type: string
              description: Description of the expected format/range
              example: Float between 0.1 and 5.0

    # Processing Error
    ProcessingError:
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          required:
            - stage
            - recoverable
          properties:
            stage:
              type: string
              description: Which processing stage failed
              enum:
                - image_loading
                - watermark_embedding
                - watermark_extraction
                - geometry_alignment
                - blind_verification
              example: image_loading
            recoverable:
              type: boolean
              description: Whether the operation can be retried
              example: false
            technical_details:
              type: string
              description: Stack trace or technical error message (for debugging)

  responses:
    # 400 Bad Request Responses
    InvalidFileFormat:
      description: Unsupported image file format
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error_code: INVALID_FILE_FORMAT
            message: Only PNG and JPG images are supported
            details:
              provided_type: image/webp
              supported_types: ["image/png", "image/jpeg"]
            suggestion: Please convert your image to PNG or JPG format and try again

    FileTooLarge:
      description: Uploaded file exceeds size limit
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error_code: FILE_TOO_LARGE
            message: File size exceeds the 10MB limit
            details:
              file_size_bytes: 15728640
              file_size_mb: 15.0
              max_size_mb: 10.0
            suggestion: Please compress or resize your image to under 10MB

    EmptyText:
      description: Watermark text is empty or only whitespace
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            status: error
            error_code: EMPTY_TEXT
            message: Watermark text cannot be empty
            field: text
            value_provided: "   "
            expected: Non-empty string (1-240 characters)
            suggestion: Please enter some text to embed as a watermark

    TextTooLong:
      description: Watermark text exceeds maximum length
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            status: error
            error_code: TEXT_TOO_LONG
            message: Watermark text exceeds maximum length
            field: text
            value_provided: "[...300 characters...]"
            expected: String with 1-240 characters
            details:
              provided_length: 300
              max_length: 240
            suggestion: Please shorten your watermark text to 240 characters or less

    InvalidAlphaRange:
      description: Alpha value is outside valid range
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            status: error
            error_code: INVALID_ALPHA_RANGE
            message: Alpha value must be between 0.1 and 5.0
            field: alpha
            value_provided: 100.0
            expected: Float between 0.1 and 5.0
            details:
              min: 0.1
              max: 5.0
            suggestion: Adjust the strength slider to a value between 0.1 and 5.0

    MissingFile:
      description: Required file was not uploaded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            status: error
            error_code: MISSING_FILE
            message: Image file is required
            field: file
            expected: Valid image file (PNG or JPG)
            suggestion: Please upload an image file

    MissingOriginalFile:
      description: Original file required for extraction was not uploaded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            status: error
            error_code: MISSING_ORIGINAL_FILE
            message: Original image is required for watermark extraction
            field: original_file
            expected: Valid image file (PNG or JPG)
            suggestion: Please upload the original watermarked image

    MissingSuspectFile:
      description: Suspect file required for extraction was not uploaded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
          example:
            status: error
            error_code: MISSING_SUSPECT_FILE
            message: Suspect image is required for watermark extraction
            field: suspect_file
            expected: Valid image file (PNG or JPG)
            suggestion: Please upload the suspect image to extract watermark from

    # 500 Internal Server Error Responses
    ImageDecodeError:
      description: Failed to decode uploaded image
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProcessingError'
          example:
            status: error
            error_code: IMAGE_DECODE_ERROR
            message: Could not decode the uploaded image
            stage: image_loading
            recoverable: false
            details:
              file_size: 1234567
              content_type: image/jpeg
            suggestion: The image file may be corrupted. Try uploading a different image

    WatermarkEmbedFailed:
      description: Watermark embedding algorithm failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProcessingError'
          example:
            status: error
            error_code: WATERMARK_EMBED_FAILED
            message: Failed to embed watermark into image
            stage: watermark_embedding
            recoverable: true
            details:
              error_type: DWT decomposition failed
            suggestion: Try adjusting the alpha value or using a different image

    WatermarkExtractFailed:
      description: Watermark extraction algorithm failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProcessingError'
          example:
            status: error
            error_code: WATERMARK_EXTRACT_FAILED
            message: Failed to extract watermark from image
            stage: watermark_extraction
            recoverable: true
            details:
              error_type: Insufficient embedded bits
              bits_found: 1500
              bits_required: 2040
            suggestion: The image may not contain a watermark, or it has been too heavily modified

    GeometryAlignmentFailed:
      description: Could not align images geometrically
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ProcessingError'
          example:
            status: error
            error_code: GEOMETRY_ALIGNMENT_FAILED
            message: Could not align suspect image with original
            stage: geometry_alignment
            recoverable: false
            details:
              matches_found: 3
              matches_required: 10
            suggestion: The images may not be related, or the suspect image has been too heavily modified

    InternalError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            status: error
            error_code: INTERNAL_ERROR
            message: An unexpected error occurred while processing your request
            details:
              request_id: req_abc123xyz
            suggestion: Please try again. If the problem persists, contact support with request ID

  # Error Code Mapping
  examples:
    # Embed Endpoint Errors
    EmbedInvalidFileFormat:
      summary: Embed - Invalid File Format
      value:
        status: error
        error_code: INVALID_FILE_FORMAT
        message: Only PNG and JPG images are supported
        details:
          provided_type: image/gif
        suggestion: Please upload a PNG or JPG image

    EmbedEmptyText:
      summary: Embed - Empty Watermark Text
      value:
        status: error
        error_code: EMPTY_TEXT
        message: Watermark text cannot be empty
        field: text
        suggestion: Please enter some text to embed

    EmbedInvalidAlpha:
      summary: Embed - Invalid Alpha Value
      value:
        status: error
        error_code: INVALID_ALPHA_RANGE
        message: Alpha value must be between 0.1 and 5.0
        field: alpha
        value_provided: -1.0
        expected: Float between 0.1 and 5.0

    # Extract Endpoint Errors
    ExtractMissingOriginal:
      summary: Extract - Missing Original File
      value:
        status: error
        error_code: MISSING_ORIGINAL_FILE
        message: Both original and suspect images are required
        field: original_file
        suggestion: Please upload the original watermarked image

    ExtractMissingSuspect:
      summary: Extract - Missing Suspect File
      value:
        status: error
        error_code: MISSING_SUSPECT_FILE
        message: Both original and suspect images are required
        field: suspect_file
        suggestion: Please upload the suspect image

    ExtractAlignmentFailed:
      summary: Extract - Geometric Alignment Failed
      value:
        status: error
        error_code: GEOMETRY_ALIGNMENT_FAILED
        message: Could not align the two images
        stage: geometry_alignment
        recoverable: false
        details:
          reason: Insufficient feature matches
        suggestion: Ensure the suspect image is a modified version of the original

    # Verify Endpoint Errors
    VerifyNoWatermark:
      summary: Verify - No Watermark Detected (NOT an error)
      value:
        status: success
        data:
          verified: false
          watermark_text: ""
          confidence: 0.0
          metadata:
            message: No Watermark Detected
            reason: Sync template not found or payload parsing failed

    VerifyImageDecodeError:
      summary: Verify - Image Decode Error
      value:
        status: error
        error_code: IMAGE_DECODE_ERROR
        message: Could not decode the uploaded image
        stage: image_loading
        suggestion: Please upload a valid PNG or JPG image

# HTTP Status Code Guidelines
tags:
  - name: Error Handling
    description: |
      ## HTTP Status Code Usage
      
      - **200 OK**: Operation succeeded (even if no watermark found in Verify)
      - **400 Bad Request**: Client input validation failed (invalid format, missing field, out-of-range value)
      - **422 Unprocessable Entity**: Request was well-formed but semantically incorrect
      - **500 Internal Server Error**: Server-side processing error (image decode failure, algorithm crash)
      
      ## Error Response Format
      
      All error responses follow the `ErrorResponse` schema with:
      - `status`: Always "error"
      - `error_code`: Uppercase snake_case constant
      - `message`: Human-readable description
      - `details`: Optional additional context
      - `suggestion`: Optional actionable guidance
      
      ## Client-Side Validation
      
      Clients SHOULD perform validation before sending requests:
      - Check file type and size
      - Validate text field is not empty
      - Ensure alpha is in valid range [0.1, 5.0]
      - Show user-friendly error messages inline
      
      ## Server-Side Validation
      
      Servers MUST:
      - Validate all input parameters
      - Return detailed error codes
      - Provide actionable suggestions
      - Log errors for debugging (but don't expose sensitive details to client)
